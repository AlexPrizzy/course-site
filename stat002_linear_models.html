<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Statistical learning: linear regression</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45631879-2', 'auto');
  ga('send', 'pageview');

</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 66px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 71px;
  margin-top: -71px;
}

.section h2 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h3 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h4 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h5 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h6 {
  padding-top: 71px;
  margin-top: -71px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Computing for the Social Sciences</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="faq.html">FAQ</a>
</li>
<li>
  <a href="syllabus.html">Syllabus</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Statistical learning: linear regression</h1>

</div>


<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(modelr)
<span class="kw">library</span>(broom)
<span class="kw">library</span>(rcfss)
<span class="kw">set.seed</span>(<span class="dv">1234</span>)

<span class="kw">theme_set</span>(<span class="kw">theme_minimal</span>())</code></pre></div>
<div id="linear-models-using-ggplot2" class="section level1">
<h1>Linear models using <code>ggplot2</code></h1>
<p>Linear models are the simplest to understand. They adopt a generic form</p>
<p><span class="math display">\[y = \beta_0 + \beta_1 * x\]</span></p>
<p>where <span class="math inline">\(y\)</span> is the <strong>outcome of interest</strong>, <span class="math inline">\(x\)</span> is the <strong>explanatory</strong> or <strong>predictor</strong> variable, and <span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(\beta_1\)</span> are <strong>parameters</strong> that vary to capture different patterns. Given the empirical values you have for <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>, you generate a <strong>fitted model</strong> that finds the values for the parameters that best fit the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sim1, <span class="kw">aes</span>(x, y)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>()</code></pre></div>
<p><img src="stat002_linear_models_files/figure-html/sim-plot-1.png" width="672" /></p>
<p>This looks like a linear relationship. We could randomly generate parameters for the formula <span class="math inline">\(y = \beta_0 + \beta_1 * x\)</span> to try and explain or predict the relationship between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">models &lt;-<span class="st"> </span><span class="kw">tibble</span>(
  <span class="dt">a1 =</span> <span class="kw">runif</span>(<span class="dv">250</span>, <span class="op">-</span><span class="dv">20</span>, <span class="dv">40</span>),
  <span class="dt">a2 =</span> <span class="kw">runif</span>(<span class="dv">250</span>, <span class="op">-</span><span class="dv">5</span>, <span class="dv">5</span>)
)

<span class="kw">ggplot</span>(sim1, <span class="kw">aes</span>(x, y)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="kw">aes</span>(<span class="dt">intercept =</span> a1, <span class="dt">slope =</span> a2), <span class="dt">data =</span> models, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>()</code></pre></div>
<p><img src="stat002_linear_models_files/figure-html/sim-random-fit-1.png" width="672" /></p>
<p>But obviously some parameters are better than others. We need a definition that can be used to differentiate good parameters from bad parameters. One approach widely used is called <strong>least squares</strong> - it means that the overall solution minimizes the sum of the squares of the errors made in the results of every single equation. The errors are simply the vertical difference between the actual values for <span class="math inline">\(y\)</span> and the predicted values for <span class="math inline">\(y\)</span>.</p>
<p><img src="stat002_linear_models_files/figure-html/sim-error-1.png" width="672" /></p>
<p><a href="http://r4ds.had.co.nz/model-basics.html">R for Data Science</a> walks you through the steps to perform all these calculations manually by writing your own functions. I encourage you to read through and practice some of this code, especially if you have no experience with linear models.</p>
<p>However for our purposes here I will assume you at least get the basics of this process. You can use <code>ggplot2</code> to draw the best-fit line:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sim1, <span class="kw">aes</span>(x, y)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>)</code></pre></div>
<p><img src="stat002_linear_models_files/figure-html/sim-plot-lm-1.png" width="672" /></p>
<p>The line in blue is the best-fit line, with 95% confidence intervals in grey indicating a range of values so defined that there is a 95% probability that the true value of a parameter lies within it. If you want to learn more about the precise definition of confidence intervals and the debate over how useful they actually are, you should take a statistics class.</p>
</div>
<div id="estimating-a-linear-model-using-lm" class="section level1">
<h1>Estimating a linear model using <code>lm()</code></h1>
<p>But drawing a picture is not always good enough. What if you want to know the actual values of the estimated parameters? To do that, we use the <code>lm()</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sim1_mod &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> sim1)
<span class="kw">coef</span>(sim1_mod)</code></pre></div>
<pre><code>## (Intercept)           x 
##    4.220822    2.051533</code></pre>
<p>The <code>lm()</code> function takes two parameters. The first is a <em>formula</em> specifying the equation to be estimated (<code>lm()</code> translates <code>y ~ x</code> into <span class="math inline">\(y = \beta_0 + \beta_1 * x\)</span>). The second is of course the data frame containing the variables.</p>
<p>Note that we have now begun to leave the <code>tidyverse</code> universe. <code>lm()</code> is part of the base R program, and the result of <code>lm()</code> is decidedly <strong>not tidy</strong>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(sim1_mod)</code></pre></div>
<pre><code>## List of 12
##  $ coefficients : Named num [1:2] 4.22 2.05
##   ..- attr(*, &quot;names&quot;)= chr [1:2] &quot;(Intercept)&quot; &quot;x&quot;
##  $ residuals    : Named num [1:30] -2.072 1.238 -4.147 0.665 1.919 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:30] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
##  $ effects      : Named num [1:30] -84.92 32.275 -4.13 0.761 2.015 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:30] &quot;(Intercept)&quot; &quot;x&quot; &quot;&quot; &quot;&quot; ...
##  $ rank         : int 2
##  $ fitted.values: Named num [1:30] 6.27 6.27 6.27 8.32 8.32 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:30] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
##  $ assign       : int [1:2] 0 1
##  $ qr           :List of 5
##   ..$ qr   : num [1:30, 1:2] -5.477 0.183 0.183 0.183 0.183 ...
##   .. ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. .. ..$ : chr [1:30] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
##   .. .. ..$ : chr [1:2] &quot;(Intercept)&quot; &quot;x&quot;
##   .. ..- attr(*, &quot;assign&quot;)= int [1:2] 0 1
##   ..$ qraux: num [1:2] 1.18 1.24
##   ..$ pivot: int [1:2] 1 2
##   ..$ tol  : num 1e-07
##   ..$ rank : int 2
##   ..- attr(*, &quot;class&quot;)= chr &quot;qr&quot;
##  $ df.residual  : int 28
##  $ xlevels      : Named list()
##  $ call         : language lm(formula = y ~ x, data = sim1)
##  $ terms        :Classes &#39;terms&#39;, &#39;formula&#39;  language y ~ x
##   .. ..- attr(*, &quot;variables&quot;)= language list(y, x)
##   .. ..- attr(*, &quot;factors&quot;)= int [1:2, 1] 0 1
##   .. .. ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. .. .. ..$ : chr [1:2] &quot;y&quot; &quot;x&quot;
##   .. .. .. ..$ : chr &quot;x&quot;
##   .. ..- attr(*, &quot;term.labels&quot;)= chr &quot;x&quot;
##   .. ..- attr(*, &quot;order&quot;)= int 1
##   .. ..- attr(*, &quot;intercept&quot;)= int 1
##   .. ..- attr(*, &quot;response&quot;)= int 1
##   .. ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt; 
##   .. ..- attr(*, &quot;predvars&quot;)= language list(y, x)
##   .. ..- attr(*, &quot;dataClasses&quot;)= Named chr [1:2] &quot;numeric&quot; &quot;numeric&quot;
##   .. .. ..- attr(*, &quot;names&quot;)= chr [1:2] &quot;y&quot; &quot;x&quot;
##  $ model        :&#39;data.frame&#39;:   30 obs. of  2 variables:
##   ..$ y: num [1:30] 4.2 7.51 2.13 8.99 10.24 ...
##   ..$ x: int [1:30] 1 1 1 2 2 2 3 3 3 4 ...
##   ..- attr(*, &quot;terms&quot;)=Classes &#39;terms&#39;, &#39;formula&#39;  language y ~ x
##   .. .. ..- attr(*, &quot;variables&quot;)= language list(y, x)
##   .. .. ..- attr(*, &quot;factors&quot;)= int [1:2, 1] 0 1
##   .. .. .. ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. .. .. .. ..$ : chr [1:2] &quot;y&quot; &quot;x&quot;
##   .. .. .. .. ..$ : chr &quot;x&quot;
##   .. .. ..- attr(*, &quot;term.labels&quot;)= chr &quot;x&quot;
##   .. .. ..- attr(*, &quot;order&quot;)= int 1
##   .. .. ..- attr(*, &quot;intercept&quot;)= int 1
##   .. .. ..- attr(*, &quot;response&quot;)= int 1
##   .. .. ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt; 
##   .. .. ..- attr(*, &quot;predvars&quot;)= language list(y, x)
##   .. .. ..- attr(*, &quot;dataClasses&quot;)= Named chr [1:2] &quot;numeric&quot; &quot;numeric&quot;
##   .. .. .. ..- attr(*, &quot;names&quot;)= chr [1:2] &quot;y&quot; &quot;x&quot;
##  - attr(*, &quot;class&quot;)= chr &quot;lm&quot;</code></pre>
<p>The result is stored in a complex list that contains a lot of important information, some of which you may recognize but most of it you do not. Here I will show you tools for extracting useful information from <code>lm()</code>.</p>
<div id="generating-predicted-values" class="section level2">
<h2>Generating predicted values</h2>
<p>We can use <code>sim1_mod</code> to generate <strong>predicted values</strong>, or the expected value for <span class="math inline">\(Y\)</span> given our knowledge of hypothetical observations with values for <span class="math inline">\(X\)</span>, based on the estimated parameters using <code>modelr::data_grid()</code> and <code>broom::augment()</code>.<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> <code>data_grid()</code> generates an evenly spaced grid of data points covering the region where observed data lies. The first argument is a data frame, and subsequent arguments identify unique columns and generates all possible combinations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">grid &lt;-<span class="st"> </span>sim1 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">data_grid</span>(x) 
grid</code></pre></div>
<pre><code>## # A tibble: 10 x 1
##        x
##    &lt;int&gt;
##  1     1
##  2     2
##  3     3
##  4     4
##  5     5
##  6     6
##  7     7
##  8     8
##  9     9
## 10    10</code></pre>
<p><code>augment()</code> takes a model object and a data frame, and uses the model to generate predictions for each observation in the data frame.<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">grid &lt;-<span class="st"> </span><span class="kw">augment</span>(sim1_mod, <span class="dt">newdata =</span> grid)
grid</code></pre></div>
<pre><code>## # A tibble: 10 x 3
##        x .fitted .se.fit
##  * &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt;
##  1     1    6.27   0.748
##  2     2    8.32   0.634
##  3     3   10.4    0.533
##  4     4   12.4    0.454
##  5     5   14.5    0.408
##  6     6   16.5    0.408
##  7     7   18.6    0.454
##  8     8   20.6    0.533
##  9     9   22.7    0.634
## 10    10   24.7    0.748</code></pre>
<p>Using this information, we can draw the best-fit line without using <code>geom_smooth()</code>, and instead build it directly from the predicted values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sim1, <span class="kw">aes</span>(x)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> y)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> .fitted), <span class="dt">data =</span> grid, <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> .fitted), <span class="dt">data =</span> grid, <span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">size =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="stat002_linear_models_files/figure-html/plot-lm-predict-1.png" width="672" /></p>
<p>This looks like the line from before, but without the confidence interval. This is a bit more involved of a process, but it can work with any type of model you create - not just very basic, linear models.</p>
</div>
<div id="residuals" class="section level2">
<h2>Residuals</h2>
<p>We can also calculate the <strong>residuals</strong>, or that distance between the actual and predicted values of <span class="math inline">\(y\)</span>. To do that, we again use <code>augment()</code> but do not input a new data frame:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sim1_resid &lt;-<span class="st"> </span><span class="kw">augment</span>(sim1_mod)
sim1_resid</code></pre></div>
<pre><code>## # A tibble: 30 x 9
##        y     x .fitted .se.fit   .resid   .hat .sigma   .cooksd .std.resid
##  * &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
##  1  4.20     1    6.27   0.748 -2.07    0.115    2.20   6.51e-2   -1.00   
##  2  7.51     1    6.27   0.748  1.24    0.115    2.23   2.32e-2    0.598  
##  3  2.13     1    6.27   0.748 -4.15    0.115    2.08   2.61e-1   -2.00   
##  4  8.99     2    8.32   0.634  0.665   0.0828   2.24   4.49e-3    0.315  
##  5 10.2      2    8.32   0.634  1.92    0.0828   2.21   3.74e-2    0.910  
##  6 11.3      2    8.32   0.634  2.97    0.0828   2.16   8.97e-2    1.41   
##  7  7.36     3   10.4    0.533 -3.02    0.0586   2.16   6.21e-2   -1.41   
##  8 10.5      3   10.4    0.533  0.130   0.0586   2.24   1.15e-4    0.0608 
##  9 10.5      3   10.4    0.533  0.136   0.0586   2.24   1.26e-4    0.0637 
## 10 12.4      4   12.4    0.454  0.00763 0.0424   2.24   2.78e-7    0.00354
## # ... with 20 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sim1_resid, <span class="kw">aes</span>(.resid)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_freqpoly</span>(<span class="dt">binwidth =</span> <span class="fl">0.5</span>)</code></pre></div>
<p><img src="stat002_linear_models_files/figure-html/resids-1.png" width="672" /></p>
<p>Reviewing your residuals can be helpful. Sometimes your model is better at predicting some types of observations better than others. This could help you isolate further patterns and improve the predictive accuracy of your model.</p>
</div>
</div>
<div id="estimating-a-linear-models-using-gapminder" class="section level1">
<h1>Estimating a linear model(s) using <code>gapminder</code></h1>
<div id="overall-model" class="section level2">
<h2>Overall model</h2>
<p>Recall the <code>gapminder</code> dataset, which includes measures of life expectancy over time for all countries in the world.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(gapminder)
gapminder</code></pre></div>
<pre><code>## # A tibble: 1,704 x 6
##    country     continent  year lifeExp      pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8  8425333      779.
##  2 Afghanistan Asia       1957    30.3  9240934      821.
##  3 Afghanistan Asia       1962    32.0 10267083      853.
##  4 Afghanistan Asia       1967    34.0 11537966      836.
##  5 Afghanistan Asia       1972    36.1 13079460      740.
##  6 Afghanistan Asia       1977    38.4 14880372      786.
##  7 Afghanistan Asia       1982    39.9 12881816      978.
##  8 Afghanistan Asia       1987    40.8 13867957      852.
##  9 Afghanistan Asia       1992    41.7 16317921      649.
## 10 Afghanistan Asia       1997    41.8 22227415      635.
## # ... with 1,694 more rows</code></pre>
<p>Let’s say we want to try and understand how life expectancy changes over time. We could visualize the data using a line graph:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(year, lifeExp, <span class="dt">group =</span> country)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>)</code></pre></div>
<p><img src="stat002_linear_models_files/figure-html/lifeExp-by-country-1.png" width="672" /></p>
<p>But this is incredibly noise. Why not estimate a simple linear model that summarizes this trend?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder_mod &lt;-<span class="st"> </span><span class="kw">lm</span>(lifeExp <span class="op">~</span><span class="st"> </span>year, <span class="dt">data =</span> gapminder)
<span class="kw">summary</span>(gapminder_mod)</code></pre></div>
<pre><code>## 
## Call:
## lm(formula = lifeExp ~ year, data = gapminder)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -39.949  -9.651   1.697  10.335  22.158 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -585.65219   32.31396  -18.12   &lt;2e-16 ***
## year           0.32590    0.01632   19.96   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 11.63 on 1702 degrees of freedom
## Multiple R-squared:  0.1898, Adjusted R-squared:  0.1893 
## F-statistic: 398.6 on 1 and 1702 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">grid &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">data_grid</span>(year, country) 
grid</code></pre></div>
<pre><code>## # A tibble: 1,704 x 2
##     year country    
##    &lt;int&gt; &lt;fct&gt;      
##  1  1952 Afghanistan
##  2  1952 Albania    
##  3  1952 Algeria    
##  4  1952 Angola     
##  5  1952 Argentina  
##  6  1952 Australia  
##  7  1952 Austria    
##  8  1952 Bahrain    
##  9  1952 Bangladesh 
## 10  1952 Belgium    
## # ... with 1,694 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">grid &lt;-<span class="st"> </span><span class="kw">augment</span>(gapminder_mod, <span class="dt">newdata =</span> grid) 
grid</code></pre></div>
<pre><code>## # A tibble: 1,704 x 4
##     year country     .fitted .se.fit
##  * &lt;int&gt; &lt;fct&gt;         &lt;dbl&gt;   &lt;dbl&gt;
##  1  1952 Afghanistan    50.5   0.530
##  2  1952 Albania        50.5   0.530
##  3  1952 Algeria        50.5   0.530
##  4  1952 Angola         50.5   0.530
##  5  1952 Argentina      50.5   0.530
##  6  1952 Australia      50.5   0.530
##  7  1952 Austria        50.5   0.530
##  8  1952 Bahrain        50.5   0.530
##  9  1952 Bangladesh     50.5   0.530
## 10  1952 Belgium        50.5   0.530
## # ... with 1,694 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(gapminder, <span class="kw">aes</span>(year, <span class="dt">group =</span> country)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> lifeExp), <span class="dt">alpha =</span> .<span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> .fitted), <span class="dt">data =</span> grid, <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="stat002_linear_models_files/figure-html/lifeExp-mod-1.png" width="672" /></p>
<p>So it appears that there is a positive trend - that is, over time life expectancy is rising. But we can also see a lot of variation in that trend - some countries are doing much better than others. We’ll come back to that in a bit.</p>
</div>
<div id="extracting-model-statistics" class="section level2">
<h2>Extracting model statistics</h2>
<p>Model objects are not very pretty in R. Recall the complicated data structure I mentioned above:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(gapminder_mod)</code></pre></div>
<pre><code>## List of 12
##  $ coefficients : Named num [1:2] -585.652 0.326
##   ..- attr(*, &quot;names&quot;)= chr [1:2] &quot;(Intercept)&quot; &quot;year&quot;
##  $ residuals    : Named num [1:1704] -21.7 -21.8 -21.8 -21.4 -20.9 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:1704] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
##  $ effects      : Named num [1:1704] -2455.1 232.2 -20.8 -20.5 -20.2 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:1704] &quot;(Intercept)&quot; &quot;year&quot; &quot;&quot; &quot;&quot; ...
##  $ rank         : int 2
##  $ fitted.values: Named num [1:1704] 50.5 52.1 53.8 55.4 57 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:1704] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
##  $ assign       : int [1:2] 0 1
##  $ qr           :List of 5
##   ..$ qr   : num [1:1704, 1:2] -41.2795 0.0242 0.0242 0.0242 0.0242 ...
##   .. ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. .. ..$ : chr [1:1704] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
##   .. .. ..$ : chr [1:2] &quot;(Intercept)&quot; &quot;year&quot;
##   .. ..- attr(*, &quot;assign&quot;)= int [1:2] 0 1
##   ..$ qraux: num [1:2] 1.02 1.03
##   ..$ pivot: int [1:2] 1 2
##   ..$ tol  : num 1e-07
##   ..$ rank : int 2
##   ..- attr(*, &quot;class&quot;)= chr &quot;qr&quot;
##  $ df.residual  : int 1702
##  $ xlevels      : Named list()
##  $ call         : language lm(formula = lifeExp ~ year, data = gapminder)
##  $ terms        :Classes &#39;terms&#39;, &#39;formula&#39;  language lifeExp ~ year
##   .. ..- attr(*, &quot;variables&quot;)= language list(lifeExp, year)
##   .. ..- attr(*, &quot;factors&quot;)= int [1:2, 1] 0 1
##   .. .. ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. .. .. ..$ : chr [1:2] &quot;lifeExp&quot; &quot;year&quot;
##   .. .. .. ..$ : chr &quot;year&quot;
##   .. ..- attr(*, &quot;term.labels&quot;)= chr &quot;year&quot;
##   .. ..- attr(*, &quot;order&quot;)= int 1
##   .. ..- attr(*, &quot;intercept&quot;)= int 1
##   .. ..- attr(*, &quot;response&quot;)= int 1
##   .. ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt; 
##   .. ..- attr(*, &quot;predvars&quot;)= language list(lifeExp, year)
##   .. ..- attr(*, &quot;dataClasses&quot;)= Named chr [1:2] &quot;numeric&quot; &quot;numeric&quot;
##   .. .. ..- attr(*, &quot;names&quot;)= chr [1:2] &quot;lifeExp&quot; &quot;year&quot;
##  $ model        :&#39;data.frame&#39;:   1704 obs. of  2 variables:
##   ..$ lifeExp: num [1:1704] 28.8 30.3 32 34 36.1 ...
##   ..$ year   : int [1:1704] 1952 1957 1962 1967 1972 1977 1982 1987 1992 1997 ...
##   ..- attr(*, &quot;terms&quot;)=Classes &#39;terms&#39;, &#39;formula&#39;  language lifeExp ~ year
##   .. .. ..- attr(*, &quot;variables&quot;)= language list(lifeExp, year)
##   .. .. ..- attr(*, &quot;factors&quot;)= int [1:2, 1] 0 1
##   .. .. .. ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. .. .. .. ..$ : chr [1:2] &quot;lifeExp&quot; &quot;year&quot;
##   .. .. .. .. ..$ : chr &quot;year&quot;
##   .. .. ..- attr(*, &quot;term.labels&quot;)= chr &quot;year&quot;
##   .. .. ..- attr(*, &quot;order&quot;)= int 1
##   .. .. ..- attr(*, &quot;intercept&quot;)= int 1
##   .. .. ..- attr(*, &quot;response&quot;)= int 1
##   .. .. ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt; 
##   .. .. ..- attr(*, &quot;predvars&quot;)= language list(lifeExp, year)
##   .. .. ..- attr(*, &quot;dataClasses&quot;)= Named chr [1:2] &quot;numeric&quot; &quot;numeric&quot;
##   .. .. .. ..- attr(*, &quot;names&quot;)= chr [1:2] &quot;lifeExp&quot; &quot;year&quot;
##  - attr(*, &quot;class&quot;)= chr &quot;lm&quot;</code></pre>
<p>In order to extract model statistics and use them in a <strong>tidy</strong> manner, we can use a set of functions from the <code>broom</code> package. For these functions, the input is always the model object itself, not the original data frame.</p>
<div id="tidy" class="section level3">
<h3><code>tidy()</code></h3>
<p><code>tidy()</code> constructs a data frame that summarizes the model’s statistical findings. This includes <strong>coefficients</strong> and <strong>p-values</strong> for each parameter in a regression model. Note that depending on the statistical learning method employed, the statistics stored in the columns may vary.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tidy</span>(gapminder_mod)</code></pre></div>
<pre><code>## # A tibble: 2 x 5
##   term        estimate std.error statistic  p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept) -586.      32.3        -18.1 2.90e-67
## 2 year           0.326    0.0163      20.0 7.55e-80</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tidy</span>(gapminder_mod) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str</span>()</code></pre></div>
<pre><code>## Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    2 obs. of  5 variables:
##  $ term     : chr  &quot;(Intercept)&quot; &quot;year&quot;
##  $ estimate : num  -585.652 0.326
##  $ std.error: num  32.314 0.0163
##  $ statistic: num  -18.1 20
##  $ p.value  : num  2.90e-67 7.55e-80</code></pre>
<p>Notice that the structure of the resulting object is a tidy data frame. Every row contains a single parameter, every column contains a single statistic, and every cell contains exactly one value.</p>
</div>
<div id="augment" class="section level3">
<h3><code>augment()</code></h3>
<p><code>augment()</code> adds columns to the original data that was modeled. This could include predictions, residuals, and other observation-level statistics.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">augment</span>(gapminder_mod) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">as_tibble</span>()</code></pre></div>
<pre><code>## # A tibble: 1,704 x 9
##    lifeExp  year .fitted .se.fit .resid     .hat .sigma  .cooksd .std.resid
##  *   &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
##  1    28.8  1952    50.5   0.530  -21.7 0.00208    11.6 0.00363       -1.87
##  2    30.3  1957    52.1   0.463  -21.8 0.00158    11.6 0.00279       -1.88
##  3    32.0  1962    53.8   0.401  -21.8 0.00119    11.6 0.00209       -1.87
##  4    34.0  1967    55.4   0.348  -21.4 0.000895   11.6 0.00151       -1.84
##  5    36.1  1972    57.0   0.307  -20.9 0.000698   11.6 0.00113       -1.80
##  6    38.4  1977    58.7   0.285  -20.2 0.000599   11.6 0.000907      -1.74
##  7    39.9  1982    60.3   0.285  -20.4 0.000599   11.6 0.000926      -1.76
##  8    40.8  1987    61.9   0.307  -21.1 0.000698   11.6 0.00115       -1.81
##  9    41.7  1992    63.5   0.348  -21.9 0.000895   11.6 0.00159       -1.88
## 10    41.8  1997    65.2   0.401  -23.4 0.00119    11.6 0.00242       -2.01
## # ... with 1,694 more rows</code></pre>
<p><code>augment()</code> will return statistics to the original data used to estimate the model, however if you supply a data frame under the <code>newdata</code> argument, it will return a more limited set of statistics.</p>
</div>
<div id="glance" class="section level3">
<h3><code>glance()</code></h3>
<p><code>glance()</code> constructs a concise one-row summary of the model. This typically contains values such as <span class="math inline">\(R^2\)</span>, adjusted <span class="math inline">\(R^2\)</span>, and residual standard error that are computed once for the entire model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glance</span>(gapminder_mod)</code></pre></div>
<pre><code>## # A tibble: 1 x 11
##   r.squared adj.r.squared sigma statistic  p.value    df logLik    AIC
## *     &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1     0.190         0.189  11.6      399. 7.55e-80     2 -6598. 13202.
## # ... with 3 more variables: BIC &lt;dbl&gt;, deviance &lt;dbl&gt;, df.residual &lt;int&gt;</code></pre>
<p>While <code>broom</code> may not work with every model in R, it is compatible with a wide range of common statistical models. A full list of models with which <code>broom</code> is compatible can be found on the <a href="https://github.com/dgrtwo/broom">GitHub page for the package</a>.</p>
</div>
</div>
<div id="separate-model-for-usa" class="section level2">
<h2>Separate model for USA</h2>
<p>What if instead we wanted to fit a separate model for the United States? We can filter <code>gapminder</code> for that country and perform the analysis only on U.S. observations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gapminder <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(country <span class="op">==</span><span class="st"> &quot;United States&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(year, lifeExp)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;United States&quot;</span>)</code></pre></div>
<p><img src="stat002_linear_models_files/figure-html/gapminder-us-1.png" width="672" /></p>
</div>
<div id="separate-models-for-each-country-using-map-and-nested-data-frames" class="section level2">
<h2>Separate models for each country using <code>map()</code> and nested data frames</h2>
<p>What if we want to estimate separate models for <strong>every country</strong>? We could do this manually, creating a new data frame for each country. But this is tedious and repetitive. We learned a couple of weeks ago how to <a href="block011_iteration.html#writing_for_loops">iterate using <code>for</code> loops</a>. We could do this using a <code>for</code> loop, but this will take a bunch of code. Instead, let’s use the <a href="block011_iteration.html#map_functions"><code>map()</code> functions we already learned</a>, but add an additional component on top of that.</p>
<p>Instead of repeating an action for each <strong>column</strong> (variable), we want to repeat an action for each <strong>country</strong>, a subset of rows. To do that, we need a new data structure: the <strong>nested data frame</strong>. To create a nested data frame we start with a grouped data frame, and “nest” it:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">by_country &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(country, continent) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">nest</span>()

by_country</code></pre></div>
<pre><code>## # A tibble: 142 x 3
##    country     continent data             
##    &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;           
##  1 Afghanistan Asia      &lt;tibble [12 × 4]&gt;
##  2 Albania     Europe    &lt;tibble [12 × 4]&gt;
##  3 Algeria     Africa    &lt;tibble [12 × 4]&gt;
##  4 Angola      Africa    &lt;tibble [12 × 4]&gt;
##  5 Argentina   Americas  &lt;tibble [12 × 4]&gt;
##  6 Australia   Oceania   &lt;tibble [12 × 4]&gt;
##  7 Austria     Europe    &lt;tibble [12 × 4]&gt;
##  8 Bahrain     Asia      &lt;tibble [12 × 4]&gt;
##  9 Bangladesh  Asia      &lt;tibble [12 × 4]&gt;
## 10 Belgium     Europe    &lt;tibble [12 × 4]&gt;
## # ... with 132 more rows</code></pre>
<p>This looks very different from what you’ve seen in data frames before. Typically every cell in a data frame is a single value. But here, each element in the <code>data</code> column is actually <strong>another data frame</strong>. This demonstrates the benefits of lists - they can be used recursively to store other lists, which is exactly what data frames are.</p>
<p>Now we have one row per country, with the variables associated with each country stored in their own column. All the original data is still in this nested data frame, just stored in a different way. Note that to see the values of the variables in <code>data</code>, we use the special notation we learned previously:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">by_country<span class="op">$</span>data[[<span class="dv">1</span>]]</code></pre></div>
<pre><code>## # A tibble: 12 x 4
##     year lifeExp      pop gdpPercap
##    &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1  1952    28.8  8425333      779.
##  2  1957    30.3  9240934      821.
##  3  1962    32.0 10267083      853.
##  4  1967    34.0 11537966      836.
##  5  1972    36.1 13079460      740.
##  6  1977    38.4 14880372      786.
##  7  1982    39.9 12881816      978.
##  8  1987    40.8 13867957      852.
##  9  1992    41.7 16317921      649.
## 10  1997    41.8 22227415      635.
## 11  2002    42.1 25268405      727.
## 12  2007    43.8 31889923      975.</code></pre>
<p>It’s hard to see the overall structure, but it’s easy to use the <code>map()</code> functions to access this data and analyze it. We create a model fitting function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">country_model &lt;-<span class="st"> </span><span class="cf">function</span>(df) {
  <span class="kw">lm</span>(lifeExp <span class="op">~</span><span class="st"> </span>year, <span class="dt">data =</span> df)
}</code></pre></div>
<p>And we want to apply it to each country. That is exactly what <code>map()</code> is designed for.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">models &lt;-<span class="st"> </span><span class="kw">map</span>(by_country<span class="op">$</span>data, country_model)</code></pre></div>
<p>And because <code>models</code> is a list and we just saw how to create list-columns, we could store the models as a new column in <code>by_country</code> to keep all the data and analysis together.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">by_country &lt;-<span class="st"> </span>by_country <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="kw">map</span>(data, country_model))
by_country</code></pre></div>
<pre><code>## # A tibble: 142 x 4
##    country     continent data              model   
##    &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;            &lt;list&gt;  
##  1 Afghanistan Asia      &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  2 Albania     Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  3 Algeria     Africa    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  4 Angola      Africa    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  5 Argentina   Americas  &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  6 Australia   Oceania   &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  7 Austria     Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  8 Bahrain     Asia      &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  9 Bangladesh  Asia      &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
## 10 Belgium     Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
## # ... with 132 more rows</code></pre>
<p>Now if we filter or change the order of the observations, <code>models</code> also changes order.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">by_country <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(continent <span class="op">==</span><span class="st"> &quot;Europe&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 30 x 4
##    country                continent data              model   
##    &lt;fct&gt;                  &lt;fct&gt;     &lt;list&gt;            &lt;list&gt;  
##  1 Albania                Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  2 Austria                Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  3 Belgium                Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  4 Bosnia and Herzegovina Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  5 Bulgaria               Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  6 Croatia                Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  7 Czech Republic         Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  8 Denmark                Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
##  9 Finland                Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
## 10 France                 Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt;
## # ... with 20 more rows</code></pre>
<div id="unnesting" class="section level3">
<h3>Unnesting</h3>
<p>What if we want to compute residuals for 142 countries and 142 models? We still use the <code>add_residuals()</code> function, but we have to combine it with a <code>map()</code> function call. Because <code>add_residuals()</code> requires two arguments (<code>data</code> and <code>model</code>), we use the <code>map2()</code> function. <code>map2()</code> allows us to <code>map()</code> over two sets of inputs rather than the normal one:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">by_country &lt;-<span class="st"> </span>by_country <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">resids =</span> <span class="kw">map2</span>(data, model, add_residuals)
  )
by_country</code></pre></div>
<pre><code>## # A tibble: 142 x 5
##    country     continent data              model    resids           
##    &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;            &lt;list&gt;   &lt;list&gt;           
##  1 Afghanistan Asia      &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt; &lt;tibble [12 × 5]&gt;
##  2 Albania     Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt; &lt;tibble [12 × 5]&gt;
##  3 Algeria     Africa    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt; &lt;tibble [12 × 5]&gt;
##  4 Angola      Africa    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt; &lt;tibble [12 × 5]&gt;
##  5 Argentina   Americas  &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt; &lt;tibble [12 × 5]&gt;
##  6 Australia   Oceania   &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt; &lt;tibble [12 × 5]&gt;
##  7 Austria     Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt; &lt;tibble [12 × 5]&gt;
##  8 Bahrain     Asia      &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt; &lt;tibble [12 × 5]&gt;
##  9 Bangladesh  Asia      &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt; &lt;tibble [12 × 5]&gt;
## 10 Belgium     Europe    &lt;tibble [12 × 4]&gt; &lt;S3: lm&gt; &lt;tibble [12 × 5]&gt;
## # ... with 132 more rows</code></pre>
<p>What if you want to plot the residuals? We need to <strong>unnest</strong> the residuals. <code>unnest()</code> makes each element of the list its own row:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">resids &lt;-<span class="st"> </span><span class="kw">unnest</span>(by_country, resids)
resids</code></pre></div>
<pre><code>## # A tibble: 1,704 x 7
##    country     continent  year lifeExp      pop gdpPercap   resid
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8  8425333      779. -1.11  
##  2 Afghanistan Asia       1957    30.3  9240934      821. -0.952 
##  3 Afghanistan Asia       1962    32.0 10267083      853. -0.664 
##  4 Afghanistan Asia       1967    34.0 11537966      836. -0.0172
##  5 Afghanistan Asia       1972    36.1 13079460      740.  0.674 
##  6 Afghanistan Asia       1977    38.4 14880372      786.  1.65  
##  7 Afghanistan Asia       1982    39.9 12881816      978.  1.69  
##  8 Afghanistan Asia       1987    40.8 13867957      852.  1.28  
##  9 Afghanistan Asia       1992    41.7 16317921      649.  0.754 
## 10 Afghanistan Asia       1997    41.8 22227415      635. -0.534 
## # ... with 1,694 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">resids <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(year, resid)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> country), <span class="dt">alpha =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="dv">3</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">se =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p><img src="stat002_linear_models_files/figure-html/unnest-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="exercise-linear-regression-with-scorecard" class="section level1">
<h1>Exercise: linear regression with <code>scorecard</code></h1>
<p>Recall the <code>scorecard</code> data set which contains information on U.S. institutions of higher learning.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rcfss)
scorecard</code></pre></div>
<pre><code>## # A tibble: 1,849 x 12
##    unitid name  state type   cost admrate satavg avgfacsal pctpell comprate
##     &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;int&gt;   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
##  1 450234 ITT … KS    Priv… 28306    81.3     NA     45054   0.803    0.6  
##  2 448479 ITT … MI    Priv… 26994    98.3     NA     52857   0.774    0.336
##  3 456427 ITT … CA    Priv… 26353    89.3     NA        NA   0.704   NA    
##  4 459596 ITT … FL    Priv… 28894    58.4     NA     47196   0.778   NA    
##  5 459851 Herz… WI    Priv… 23928    68.8     NA     55089   0.610   NA    
##  6 482477 DeVr… IL    Priv… 25625    70.4     NA     62793   0.641    0.294
##  7 482547 DeVr… NV    Priv… 24265    80       NA     47556   0.636    0.636
##  8 482592 DeVr… OR    Priv…    NA    50       NA     60003   0.671    0    
##  9 482617 DeVr… TN    Priv… 20983    66.7     NA     51660   0.720    0    
## 10 482662 DeVr… WA    Priv… 21999    77.8     NA     56160   0.586    0.290
## # ... with 1,839 more rows, and 2 more variables: firstgen &lt;dbl&gt;,
## #   debt &lt;dbl&gt;</code></pre>
<p>Answer the following questions using the statistical modeling tools you have learned.</p>
<ol style="list-style-type: decimal">
<li><p>What is the relationship between admission rate and cost? Report this relationship using a scatterplot and a linear best-fit line.</p>
<details> <summary>Click for the solution</summary>
<p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(scorecard, <span class="kw">aes</span>(admrate, cost)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>)</code></pre></div>
<img src="stat002_linear_models_files/figure-html/scorecard-point-1.png" width="672" />
</p>
<p></details></p></li>
<li><p>Estimate a linear regression of the relationship between admission rate and cost, and report your results in a tidy table.</p>
<details> <summary>Click for the solution</summary>
<p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">scorecard_mod &lt;-<span class="st"> </span><span class="kw">lm</span>(cost <span class="op">~</span><span class="st"> </span>admrate, <span class="dt">data =</span> scorecard)
<span class="kw">tidy</span>(scorecard_mod)</code></pre></div>
<pre><code>## # A tibble: 2 x 5
##   term        estimate std.error statistic   p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1 (Intercept)   43607.    1001.       43.5 1.04e-284
## 2 admrate        -182.      14.4     -12.6 3.98e- 35</code></pre>
</p>
<p></details></p></li>
<li><p>Estimate separate linear regression models of the relationship between admission rate and cost for each type of college. Report the estimated parameters and standard errors in a tidy data frame.</p>
<details> <summary>Click for the solution</summary>
<p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># model-building function</span>
type_model &lt;-<span class="st"> </span><span class="cf">function</span>(df) {
  <span class="kw">lm</span>(cost <span class="op">~</span><span class="st"> </span>admrate, <span class="dt">data =</span> df)
}

<span class="co"># nest the data frame</span>
by_type &lt;-<span class="st"> </span>scorecard <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(type) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">nest</span>()
by_type</code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   type                data                 
##   &lt;chr&gt;               &lt;list&gt;               
## 1 Private, for-profit &lt;tibble [216 × 11]&gt;  
## 2 Private, nonprofit  &lt;tibble [1,092 × 11]&gt;
## 3 Public              &lt;tibble [541 × 11]&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># estimate the models</span>
by_type &lt;-<span class="st"> </span>by_type <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="kw">map</span>(data, type_model))
by_type</code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   type                data                  model   
##   &lt;chr&gt;               &lt;list&gt;                &lt;list&gt;  
## 1 Private, for-profit &lt;tibble [216 × 11]&gt;   &lt;S3: lm&gt;
## 2 Private, nonprofit  &lt;tibble [1,092 × 11]&gt; &lt;S3: lm&gt;
## 3 Public              &lt;tibble [541 × 11]&gt;   &lt;S3: lm&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># extract the parameters and print a tidy data frame</span>
by_type <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">results =</span> <span class="kw">map</span>(model, tidy)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>(results)</code></pre></div>
<pre><code>## # A tibble: 6 x 6
##   type                term         estimate std.error statistic   p.value
##   &lt;chr&gt;               &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1 Private, for-profit (Intercept)  33149.      1679.     19.7   2.20e- 49
## 2 Private, for-profit admrate        -69.0       21.2    -3.25  1.33e-  3
## 3 Private, nonprofit  (Intercept)  50797.      1112.     45.7   2.92e-254
## 4 Private, nonprofit  admrate       -198.        16.5   -12.0   2.55e- 31
## 5 Public              (Intercept)  20193.       719.     28.1   1.47e-107
## 6 Public              admrate         -7.20      10.3    -0.701 4.84e-  1</code></pre>
<p>The same approach by using an anonymous function with the <a href="http://r4ds.had.co.nz/iteration.html#shortcuts">one-sided formula format</a>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">by_type <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="kw">map</span>(data, <span class="op">~</span><span class="kw">lm</span>(cost <span class="op">~</span><span class="st"> </span>admrate, <span class="dt">data =</span> .)),
         <span class="dt">results =</span> <span class="kw">map</span>(model, tidy)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unnest</span>(results)</code></pre></div>
</p>
<p></details></p></li>
</ol>
</div>
<div id="session-info" class="section level1 toc-ignore">
<h1>Session Info</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools<span class="op">::</span><span class="kw">session_info</span>()</code></pre></div>
<pre><code>##  setting  value                       
##  version  R version 3.5.0 (2018-04-23)
##  system   x86_64, darwin15.6.0        
##  ui       X11                         
##  language (EN)                        
##  collate  en_US.UTF-8                 
##  tz       America/Chicago             
##  date     2018-07-30                  
## 
##  package    * version date       source        
##  assertthat   0.2.0   2017-04-11 CRAN (R 3.5.0)
##  backports    1.1.2   2017-12-13 CRAN (R 3.5.0)
##  base       * 3.5.0   2018-04-24 local         
##  bindr        0.1.1   2018-03-13 CRAN (R 3.5.0)
##  bindrcpp   * 0.2.2   2018-03-29 CRAN (R 3.5.0)
##  broom      * 0.5.0   2018-07-17 CRAN (R 3.5.0)
##  cellranger   1.1.0   2016-07-27 CRAN (R 3.5.0)
##  cli          1.0.0   2017-11-05 CRAN (R 3.5.0)
##  codetools    0.2-15  2016-10-05 CRAN (R 3.5.0)
##  colorspace   1.3-2   2016-12-14 CRAN (R 3.5.0)
##  compiler     3.5.0   2018-04-24 local         
##  crayon       1.3.4   2017-09-16 CRAN (R 3.5.0)
##  datasets   * 3.5.0   2018-04-24 local         
##  devtools     1.13.6  2018-06-27 CRAN (R 3.5.0)
##  digest       0.6.15  2018-01-28 CRAN (R 3.5.0)
##  dplyr      * 0.7.6   2018-06-29 cran (@0.7.6) 
##  evaluate     0.11    2018-07-17 CRAN (R 3.5.0)
##  fansi        0.2.3   2018-05-06 CRAN (R 3.5.0)
##  forcats    * 0.3.0   2018-02-19 CRAN (R 3.5.0)
##  gapminder  * 0.3.0   2017-10-31 CRAN (R 3.5.0)
##  ggplot2    * 3.0.0   2018-07-03 CRAN (R 3.5.0)
##  glue         1.3.0   2018-07-17 CRAN (R 3.5.0)
##  graphics   * 3.5.0   2018-04-24 local         
##  grDevices  * 3.5.0   2018-04-24 local         
##  grid         3.5.0   2018-04-24 local         
##  gtable       0.2.0   2016-02-26 CRAN (R 3.5.0)
##  haven        1.1.2   2018-06-27 CRAN (R 3.5.0)
##  hms          0.4.2   2018-03-10 CRAN (R 3.5.0)
##  htmltools    0.3.6   2017-04-28 CRAN (R 3.5.0)
##  httr         1.3.1   2017-08-20 CRAN (R 3.5.0)
##  jsonlite     1.5     2017-06-01 CRAN (R 3.5.0)
##  knitr        1.20    2018-02-20 CRAN (R 3.5.0)
##  labeling     0.3     2014-08-23 CRAN (R 3.5.0)
##  lattice      0.20-35 2017-03-25 CRAN (R 3.5.0)
##  lazyeval     0.2.1   2017-10-29 CRAN (R 3.5.0)
##  lubridate    1.7.4   2018-04-11 CRAN (R 3.5.0)
##  magrittr     1.5     2014-11-22 CRAN (R 3.5.0)
##  Matrix       1.2-14  2018-04-13 CRAN (R 3.5.0)
##  memoise      1.1.0   2017-04-21 CRAN (R 3.5.0)
##  methods    * 3.5.0   2018-04-24 local         
##  mgcv         1.8-24  2018-06-18 CRAN (R 3.5.0)
##  modelr     * 0.1.2   2018-05-11 CRAN (R 3.5.0)
##  munsell      0.5.0   2018-06-12 CRAN (R 3.5.0)
##  nlme         3.1-137 2018-04-07 CRAN (R 3.5.0)
##  pillar       1.3.0   2018-07-14 CRAN (R 3.5.0)
##  pkgconfig    2.0.1   2017-03-21 CRAN (R 3.5.0)
##  plyr         1.8.4   2016-06-08 CRAN (R 3.5.0)
##  purrr      * 0.2.5   2018-05-29 CRAN (R 3.5.0)
##  R6           2.2.2   2017-06-17 CRAN (R 3.5.0)
##  rcfss      * 0.1.5   2018-05-30 local         
##  Rcpp         0.12.18 2018-07-23 CRAN (R 3.5.0)
##  readr      * 1.1.1   2017-05-16 CRAN (R 3.5.0)
##  readxl       1.1.0   2018-04-20 CRAN (R 3.5.0)
##  rlang        0.2.1   2018-05-30 CRAN (R 3.5.0)
##  rmarkdown    1.10    2018-06-11 CRAN (R 3.5.0)
##  rprojroot    1.3-2   2018-01-03 CRAN (R 3.5.0)
##  rstudioapi   0.7     2017-09-07 CRAN (R 3.5.0)
##  rvest        0.3.2   2016-06-17 CRAN (R 3.5.0)
##  scales       0.5.0   2017-08-24 CRAN (R 3.5.0)
##  stats      * 3.5.0   2018-04-24 local         
##  stringi      1.2.4   2018-07-20 CRAN (R 3.5.0)
##  stringr    * 1.3.1   2018-05-10 CRAN (R 3.5.0)
##  tibble     * 1.4.2   2018-01-22 CRAN (R 3.5.0)
##  tidyr      * 0.8.1   2018-05-18 CRAN (R 3.5.0)
##  tidyselect   0.2.4   2018-02-26 CRAN (R 3.5.0)
##  tidyverse  * 1.2.1   2017-11-14 CRAN (R 3.5.0)
##  tools        3.5.0   2018-04-24 local         
##  utf8         1.1.4   2018-05-24 CRAN (R 3.5.0)
##  utils      * 3.5.0   2018-04-24 local         
##  withr        2.1.2   2018-03-15 CRAN (R 3.5.0)
##  xml2         1.2.0   2018-01-24 CRAN (R 3.5.0)
##  yaml         2.1.19  2018-05-01 CRAN (R 3.5.0)</code></pre>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p><code>package::function()</code> notation. So <code>data_grid()</code> can be found in the <code>modelr</code> package, while <code>augment()</code> is in <code>broom</code>.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>Far more detail about <code>augment()</code> and the other core <code>broom</code> functions coming shortly.<a href="#fnref2">↩</a></p></li>
</ol>
</div>

<p>This work is licensed under the  <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0 Creative Commons License</a>.</p>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
