<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Rowwise operations, reproducible examples, and Git</title>
    <meta charset="utf-8" />
    <meta name="author" content="MACS 30500   University of Chicago" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/metropolis.css" rel="stylesheet" />
    <link href="libs/remark-css/lucy-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Rowwise operations, reproducible examples, and Git
### <a href="https://cfss.uchicago.edu">MACS 30500</a> <br /> University of Chicago

---




# Rowwise operations

* The data frame
* Tidy data structure
* Column-oriented workflow
* Row-oriented workflow

---

# Don't create odd copies of your data




```r
life_exp &lt;- gapminder[1:624, 4]
gdp_per_cap &lt;- gapminder[1:624, 6]
plot(gdp_per_cap ~ life_exp)
```

&lt;img src="index_files/figure-html/split-data-1.png" width="864" /&gt;

---

# Leave the data and reveal intent in code


```r
ggplot(
  filter(gapminder, continent == "Africa"),
  aes(x = lifeExp, y = gdpPercap)
) +
  geom_point()
```

&lt;img src="index_files/figure-html/plot-no-split-1.png" width="864" /&gt;

---

# Leave the data and reveal intent in code


```r
gapminder %&gt;%
  filter(continent == "Africa") %&gt;%
  ggplot(aes(x = lifeExp, y = gdpPercap)) +
  geom_point()
```

&lt;img src="index_files/figure-html/plot-no-split-pipe-1.png" width="864" /&gt;

---

# Leave the data and reveal intent in code


```r
plot(
  gdpPercap ~ lifeExp,
  data = subset(gapminder, subset = continent == "Africa")
)
```

&lt;img src="index_files/figure-html/plot-no-split-base-1.png" width="864" /&gt;

---

# Add or modify a variable


```r
# Function to produce a fresh example data frame
new_df &lt;- function() {
  tribble(
    ~name, ~age,
    "Reed", 14L,
    "Wesley", 12L,
    "Eli", 12L,
    "Toby", 1L
  )
}
```

---

# The `df$var &lt;- ...` syntax

`df$var &lt;- ...` 

--

## The downsides

* Silent recycling is a risk
* `df` is not special
* I have aesthetic concerns

---

# The `df$var &lt;- ...` syntax


```r
df &lt;- new_df()
df$eyes &lt;- 2L
df$snack &lt;- c("chips", "cheese")
df$uname &lt;- toupper(df$name)
df
```

```
## # A tibble: 4 x 5
##   name     age  eyes snack  uname 
##   &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;chr&gt; 
## 1 Reed      14     2 chips  REED  
## 2 Wesley    12     2 cheese WESLEY
## 3 Eli       12     2 chips  ELI   
## 4 Toby       1     2 cheese TOBY
```

---

# `dplyr::mutate()` works "inside the box"

* Only a length one input can be recycled.
* `df` is the first place to look for things
* Pipe-friendly
* I like the way this looks

---

# `dplyr::mutate()` works "inside the box"


```r
new_df() %&gt;%
  mutate(
    eyes = 2L,
    snack = c("chips", "cheese"),
    uname = toupper(name)
  )
```

```
## Error: Column `snack` must be length 4 (the number of rows) or one, not 2
```

---

# `dplyr::mutate()` works "inside the box"


```r
new_df() %&gt;%
  mutate(
    eyes = 2L,
    snack = c("chips", "cheese", "mixed nuts", "dried peas"),
    uname = str_to_upper(name)
  )
```

```
## # A tibble: 4 x 5
##   name     age  eyes snack      uname 
##   &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;chr&gt;      &lt;chr&gt; 
## 1 Reed      14     2 chips      REED  
## 2 Wesley    12     2 cheese     WESLEY
## 3 Eli       12     2 mixed nuts ELI   
## 4 Toby       1     2 dried peas TOBY
```

---

# Do you really need to iterate over rows?


```r
df &lt;- new_df()
paste(df$name[1], "is", df$age[1], "years old")
```

```
## [1] "Reed is 14 years old"
```

--


```r
n &lt;- nrow(df)
s &lt;- vector(mode = "character", length = n)
for (i in seq_len(n)) {
  s[i] &lt;- paste(df$name[i], "is", df$age[i], "years old")
}
s
```

```
## [1] "Reed is 14 years old"   "Wesley is 12 years old"
## [3] "Eli is 12 years old"    "Toby is 1 years old"
```

--


```r
paste(df$name, "is", df$age, "years old")
```

```
## [1] "Reed is 14 years old"   "Wesley is 12 years old"
## [3] "Eli is 12 years old"    "Toby is 1 years old"
```

---

# Don't forget to work "inside the box"


```r
str_glue_data(df, "{name} is {age} years old")
```

```
## Reed is 14 years old
## Wesley is 12 years old
## Eli is 12 years old
## Toby is 1 years old
```

--


```r
df %&gt;%
  mutate(sentence = str_glue("{name} is {age} years old"))
```

```
## # A tibble: 4 x 3
##   name     age sentence              
##   &lt;chr&gt;  &lt;int&gt; &lt;glue&gt;                
## 1 Reed      14 Reed is 14 years old  
## 2 Wesley    12 Wesley is 12 years old
## 3 Eli       12 Eli is 12 years old   
## 4 Toby       1 Toby is 1 years old
```

---

# `map()` for functions that are not vectorized


```r
df_list &lt;- list(
  mass_shootings,
  gun_deaths
)
df_list
```

```
## [[1]]
## # A tibble: 114 x 14
##    case   year month   day location summary fatalities injured
##    &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;        &lt;dbl&gt;   &lt;dbl&gt;
##  1 Dayt…  2019 Aug       4 Dayton,… PENDING          9      27
##  2 El P…  2019 Aug       3 El Paso… PENDING         20      26
##  3 Gilr…  2019 Jul      28 Gilroy,… "Santi…          3      12
##  4 Virg…  2019 May      31 Virgini… "DeWay…         12       4
##  5 Harr…  2019 Feb      15 Aurora,… Gary M…          5       6
##  6 Penn…  2019 Jan      24 State C… Jordan…          3       1
##  7 SunT…  2019 Jan      23 Sebring… "Zephe…          5       0
##  8 Merc…  2018 Nov      19 Chicago… Juan L…          3       0
##  9 Thou…  2018 Nov       7 Thousan… Ian Da…         12      22
## 10 Tree…  2018 Oct      27 Pittsbu… "Rober…         11       6
## # … with 104 more rows, and 6 more variables: total_victims &lt;dbl&gt;,
## #   location_type &lt;chr&gt;, male &lt;lgl&gt;, age_of_shooter &lt;dbl&gt;, race &lt;chr&gt;,
## #   prior_mental_illness &lt;chr&gt;
## 
## [[2]]
## # A tibble: 100,798 x 10
##       id  year month intent   police sex     age race      place  education
##    &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;  &lt;fct&gt;    
##  1     1  2012 Jan   Suicide       0 M        34 Asian/Pa… Home   &lt;NA&gt;     
##  2     2  2012 Jan   Suicide       0 F        21 White     Street &lt;NA&gt;     
##  3     3  2012 Jan   Suicide       0 M        60 White     Other… &lt;NA&gt;     
##  4     4  2012 Feb   Suicide       0 M        64 White     Home   &lt;NA&gt;     
##  5     5  2012 Feb   Suicide       0 M        31 White     Other… &lt;NA&gt;     
##  6     6  2012 Feb   Suicide       0 M        17 Native A… Home   &lt;NA&gt;     
##  7     7  2012 Feb   Undeter…      0 M        48 White     Home   &lt;NA&gt;     
##  8     8  2012 Mar   Suicide       0 M        41 Native A… Home   &lt;NA&gt;     
##  9     9  2012 Feb   Acciden…      0 M        50 White     Other… &lt;NA&gt;     
## 10    10  2012 Feb   Suicide       0 M        NA Black     Home   &lt;NA&gt;     
## # … with 100,788 more rows
```

---

# `map()` for functions that are not vectorized


```r
nrow(df_list)
```

```
## NULL
```

--


```r
library(purrr)
map(df_list, nrow)
```

```
## [[1]]
## [1] 114
## 
## [[2]]
## [1] 100798
```

--


```r
map_int(df_list, ~ nrow(.x))
```

```
## [1]    114 100798
```

---

# Attack via rows or columns?


```r
x &lt;- list(
  list(name = "sue", number = 1, veg = c("onion", "carrot")),
  list(name = "doug", number = 2, veg = c("potato", "beet"))
)
x
```

```
## [[1]]
## [[1]]$name
## [1] "sue"
## 
## [[1]]$number
## [1] 1
## 
## [[1]]$veg
## [1] "onion"  "carrot"
## 
## 
## [[2]]
## [[2]]$name
## [1] "doug"
## 
## [[2]]$number
## [1] 2
## 
## [[2]]$veg
## [1] "potato" "beet"
```

---

# Combine into rows


```r
bind_rows(x)
```

```
## Error: Argument 3 must be length 1, not 2
```

```r
map_dfr(x, ~.x)
```

```
## Error: Argument 3 must be length 1, not 2
```

```r
map_dfr(x, ~ .x[c("name", "number")])
```

```
## # A tibble: 2 x 2
##   name  number
##   &lt;chr&gt;  &lt;dbl&gt;
## 1 sue        1
## 2 doug       2
```

---

# Combine into rows


```r
tibble(
  name = map_chr(x, "name"),
  number = map_dbl(x, "number"),
  veg = map(x, "veg")
)
```

```
## # A tibble: 2 x 3
##   name  number veg      
##   &lt;chr&gt;  &lt;dbl&gt; &lt;list&gt;   
## 1 sue        1 &lt;chr [2]&gt;
## 2 doug       2 &lt;chr [2]&gt;
```

---

# Work on groups of rows


```r
gapminder %&gt;%
  group_by(continent) %&gt;%
  summarise(
    life_exp_avg = mean(lifeExp),
    gdp_per_cap_avg = mean(gdpPercap)
  )
```

```
## # A tibble: 5 x 3
##   continent life_exp_avg gdp_per_cap_avg
##   &lt;fct&gt;            &lt;dbl&gt;           &lt;dbl&gt;
## 1 Africa            48.9           2194.
## 2 Americas          64.7           7136.
## 3 Asia              60.1           7902.
## 4 Europe            71.9          14469.
## 5 Oceania           74.3          18622.
```

---

# Calculate more than one number


```r
gapminder %&gt;%
  group_by(continent) %&gt;%
  summarise(life_exp_qtile = quantile(lifeExp, c(0.25, 0.5, 0.75)))
```

```
## Error: Column `life_exp_qtile` must be length 1 (a summary value), not 3
```

--


```r
gapminder %&gt;%
  group_by(continent) %&gt;%
  summarise(life_exp_qtile = list(quantile(lifeExp, c(0.25, 0.5, 0.75))))
```

```
## # A tibble: 5 x 2
##   continent life_exp_qtile
##   &lt;fct&gt;     &lt;list&gt;        
## 1 Africa    &lt;dbl [3]&gt;     
## 2 Americas  &lt;dbl [3]&gt;     
## 3 Asia      &lt;dbl [3]&gt;     
## 4 Europe    &lt;dbl [3]&gt;     
## 5 Oceania   &lt;dbl [3]&gt;
```

---

&lt;blockquote class="twitter-tweet"&gt;&lt;p lang="en" dir="ltr"&gt;this is great! in ex07 how would you unnest so the final output is a df with a fct col &amp;quot;quantile&amp;quot; c(&amp;quot;25%&amp;quot;, &amp;quot;50%&amp;quot;, &amp;quot;75%&amp;quot;)? My solutions so far are long, ugly and convoluted.&lt;/p&gt;&amp;mdash; João Santiago (@jcpsantiago) &lt;a href="https://twitter.com/jcpsantiago/status/983997363298717696?ref_src=twsrc%5Etfw"&gt;April 11, 2018&lt;/a&gt;&lt;/blockquote&gt; &lt;script async src="https://platform.twitter.com/widgets.js" charset="utf-8"&gt;&lt;/script&gt;

---

# `map()` + `unnest()`


```r
gapminder %&gt;%
  group_by(continent) %&gt;%
  summarise(life_exp_qtile = list(quantile(lifeExp, c(0.25, 0.5, 0.75)))) %&gt;%
  mutate(life_exp_qtile = map(life_exp_qtile, enframe, name = "quantile")) %&gt;%
  unnest(life_exp_qtile) %&gt;%
  mutate(quantile = factor(quantile))
```

```
## # A tibble: 15 x 3
##    continent quantile value
##    &lt;fct&gt;     &lt;fct&gt;    &lt;dbl&gt;
##  1 Africa    25%       42.4
##  2 Africa    50%       47.8
##  3 Africa    75%       54.4
##  4 Americas  25%       58.4
##  5 Americas  50%       67.0
##  6 Americas  75%       71.7
##  7 Asia      25%       51.4
##  8 Asia      50%       61.8
##  9 Asia      75%       69.5
## 10 Europe    25%       69.6
## 11 Europe    50%       72.2
## 12 Europe    75%       75.5
## 13 Oceania   25%       71.2
## 14 Oceania   50%       73.7
## 15 Oceania   75%       77.6
```

---

# `map()` + `unnest()`


```r
enquantile &lt;- function(.var, ...) {
  qtile &lt;- enframe(quantile(.var, ...), name = "quantile")
  qtile$quantile &lt;- factor(qtile$quantile)
  list(qtile)
}
```

--


```r
gapminder %&gt;%
  group_by(continent) %&gt;%
  summarise(life_exp_qtile = enquantile(lifeExp, c(0.25, 0.5, 0.75))) %&gt;%
  unnest(life_exp_qtile)
```

```
## # A tibble: 15 x 3
##    continent quantile value
##    &lt;fct&gt;     &lt;fct&gt;    &lt;dbl&gt;
##  1 Africa    25%       42.4
##  2 Africa    50%       47.8
##  3 Africa    75%       54.4
##  4 Americas  25%       58.4
##  5 Americas  50%       67.0
##  6 Americas  75%       71.7
##  7 Asia      25%       51.4
##  8 Asia      50%       61.8
##  9 Asia      75%       69.5
## 10 Europe    25%       69.6
## 11 Europe    50%       72.2
## 12 Europe    75%       75.5
## 13 Oceania   25%       71.2
## 14 Oceania   50%       73.7
## 15 Oceania   75%       77.6
```

---

# Reproducible examples

* Minimal
* Complete
* Verifiable

---

# `reprex`




```
library(tidyverse)
count(diamonds, colour)
```

---

.center[

![](https://memeshappen.com/media/created/One-does-not-simply-understand-git-meme-60285.jpg)

]

---

# Git

## What files to commit

* Source files
* Markdown files
* Data files

## What files to not commit

* Temporary files
* Log files
* Files with private details
* Any file greater than 100 megabytes

---

# `.gitignore`

* System file
* Tells Git which files/directories to ignore

---

# Git LFS

* [Git Large File Storage](https://git-lfs.github.com/)
* Separate software for tracking large files
* Integrates with Git
* Generally charges a fee

---

# Accidentally cloned from the master

&lt;div style="width:100%;height:0;padding-bottom:50%;position:relative;"&gt;&lt;iframe src="https://giphy.com/embed/3oxHQKW9lw6rK9kYtq" width="100%" height="100%" style="position:absolute" frameBorder="0" class="giphy-embed" allowFullScreen&gt;&lt;/iframe&gt;&lt;/div&gt;

---

# Accidentally cloned from the master

```bash
remote: Permission to hadley/ggplot2.git denied to bensoltoff.
fatal: unable to access 'https://github.com/hadley/ggplot2.git/': The requested URL returned error: 403
```

---

# Avoiding Git problems

1. Commit early and often
1. Push regularly to GitHub

---

# Burn it all down

.center[

![[Git (via xkcd)](https://xkcd.com/1597/)](https://imgs.xkcd.com/comics/git.png)

]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="https://cfss.uchicago.edu/slides/macros.js"></script>
<script src="https://platform.twitter.com/widgets.js"></script>
<script>var slideshow = remark.create({
"highlightLanguage": "r",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
