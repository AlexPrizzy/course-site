---
title: "Getting data from the web: API access"
author: |
  | MACS 30500
  | University of Chicago
date: "November 13, 2017"
output: rcfss::cfss_slides
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(cache = TRUE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
library(broom)
library(twitteR)
library(jsonlite)
library(curl)
library(repurrrsive)
library(listviewer)

set.seed(1234)
theme_set(theme_minimal(base_size = 18))
```

## Twitter API

* REST API
* Streaming API

* [`twitteR`](https://cran.rstudio.com/web/packages/twitteR/index.html)
* [`streamR`](https://cran.rstudio.com/web/packages/streamR/index.html)

## Using `twitteR`

```{r twitter}
library(twitteR)
```

## OAuth authentication

1. Create a Twitter account
1. Store your API key and token using the `.Rprofile` method
1. `setup_twitter_oauth()` **from the console**
1. Get back into RStudio

## Searching tweets

```{r twitter-setup, cache = FALSE}
setup_twitter_oauth(consumer_key = getOption("twitter_api_key"),
                    consumer_secret = getOption("twitter_api_token"))
```

```{r twitter-rstats}
tweets <- searchTwitter('#rstats', n = 5)
tweets
```

## Searching users

```{r twitter-clinton}
clinton <- getUser("hillaryclinton")
clinton$getDescription()
clinton$getFriends(n = 5)
```

## Tidying tweets

```{r twitter-list}
str(tweets)
```

## Tidying tweets

```{r twitter-df}
df <- twListToDF(tweets) %>%
  as_tibble()
df
```

## Exercise: Practice using `twitteR`

![](https://upload.wikimedia.org/wikipedia/commons/thumb/b/bb/Official_Portrait_of_President_Donald_Trump.jpg/379px-Official_Portrait_of_President_Donald_Trump.jpg)

## Messy API responses {.scrollable}

```{r omdb-recursive, error = TRUE, warning = FALSE}
# omdb API function
omdb <- function(Key, Title, Year, Plot, Format){
  baseurl <- "http://www.omdbapi.com/?"
  params <- c("apikey=", "t=", "y=", "plot=", "r=")
  values <- c(Key, Title, Year, Plot, Format)
  param_values <- map2_chr(params, values, str_c)
  args <- str_c(param_values, collapse = "&")
  str_c(baseurl, args)
}

# use curl to execute the query
request_sharknado <- omdb(getOption("omdb_key"), "Sharknado", "2013", "short", "json")
con <- curl(request_sharknado)
answer_json <- readLines(con)
close(con)

# convert to data frame
answer_json %>% 
  fromJSON() %>% 
  as_tibble()
```

## Whoops {.scrollable}

```{r omdb-str}
sharknado <- answer_json %>% 
  fromJSON()

str(sharknado)
jsonedit(sharknado, mode = "view", elementId = "sharknado")
```

## Inspecting and exploring lists {.scrollable}

```{r packages-lists, cache = FALSE}
library(purrr)
library(repurrrsive)
```

```{r got-view}
str(got_chars, list.len = 3)
jsonedit(got_chars, mode = "view", elementId = "got_chars")
```

## Name and position shortcuts

```{r got-name-name}
map(got_chars[1:4], "name")
```

* Equivalent to `function(x) x[["TEXT"]]`

## Name and position shortcuts

```{r got-name-int}
map(got_chars[5:8], 3)
```

* Equivalent to `function(x) x[[i]]`
    
## Name and position shortcuts with pipe

```{r got-name-pipe, eval = FALSE}
got_chars %>% 
  map("name")
got_chars %>% 
  map(3)
```
    
## Type-specific map

```{r got-name-chr}
map_chr(got_chars[9:12], "name")
map_chr(got_chars[13:16], 3)
```

## Extract multiple values {.scrollable}

```{r got-subset-one}
# Victarion element
got_chars[[3]]

# specific elements for Victarion
got_chars[[3]][c("name", "culture", "gender", "born")]
```

## Adapt to `map()` framework

```r
map(.x, .f, ...)
```

* `.f` = `[`
* `...` = character vector identifying the names of the elements to extract

## Adapt to `map()` framework

```{r got-subset}
x <- map(got_chars, `[`, c("name", "culture", "gender", "born"))
str(x[16:17])
```

## `magrittr::extract()`

```{r got-subset-magrittr, message = FALSE}
library(magrittr)

x <- map(got_chars, extract, c("name", "culture", "gender", "born"))
str(x[18:19])
```

## Data frame output

```{r got-df}
map_df(got_chars, extract, c("name", "culture", "gender", "id", "born", "alive"))
```

## More robust approach {.scrollable}

```{r got-df-robust}
got_chars %>% {
  tibble(
    name = map_chr(., "name"),
    culture = map_chr(., "culture"),
    gender = map_chr(., "gender"),       
    id = map_int(., "id"),
    born = map_chr(., "born"),
    alive = map_lgl(., "alive")
  )
}
```

## Exercise: simplify `gh_users`

![](https://assets-cdn.github.com/images/modules/logos_page/Octocat.png)

## List inside a data frame {.scrollable}

```{r gh-repos-view}
str(gh_repos, list.len = 2)
jsonedit(gh_repos, mode = "view", elementId = "gh_repos")
```

## Vector input to extraction shortcuts

```{r gh-repos-repo-name}
gh_repos %>%
  map_chr(c(1, 3))
```

## Get it into a data frame

> One row per repository, with variables identifying which GitHub user owns it, the repository name, etc.

## Create a data frame with usernames and `gh_repos`

```{r gh-repos-df}
(unames <- map_chr(gh_repos, c(1, 4, 1)))
(udf <- gh_repos %>%
    set_names(unames) %>% 
    enframe("username", "gh_repos"))
```

## How many repos are associated with each user?

```{r gh-repos-length}
udf %>% 
  mutate(n_repos = map_int(gh_repos, length))
```

## Practice on a single user {.scrollable}

```{r gh-repos-user1}
# one_user is a list of repos for one user
one_user <- udf$gh_repos[[1]]

# one_user[[1]] is a list of info for one repo
one_repo <- one_user[[1]]
str(one_repo, max.level = 1, list.len = 5)

# a highly selective list of tibble-worthy info for one repo
one_repo[c("name", "fork", "open_issues")]

# make a data frame of that info for all a user's repos
map_df(one_user, `[`, c("name", "fork", "open_issues"))
map_df(one_user, extract, c("name", "fork", "open_issues"))
```

## Scale up to all users

![](http://i0.kym-cdn.com/photos/images/facebook/000/531/557/a88.jpg)

## Scale up to all users

```{r gh-repos-inception}
udf %>% 
  mutate(repo_info = gh_repos %>%
           map(. %>%
                 map_df(extract, c("name", "fork", "open_issues"))))
```

## Tidy the data frame

```{r gh-repos-df-unnest}
(rdf <- udf %>% 
   mutate(
     repo_info = gh_repos %>%
       map(. %>%
             map_df(extract, c("name", "fork", "open_issues")))
   ) %>% 
   select(-gh_repos) %>% 
   tidyr::unnest())
```
