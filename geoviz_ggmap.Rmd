---
title: "Drawing raster maps with `ggmap`"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE)
```

```{r packages, cache = FALSE, message = FALSE}
library(tidyverse)
library(lubridate)
library(ggmap)
library(RColorBrewer)
library(gridExtra)

options(digits = 3)
set.seed(1234)
theme_set(theme_minimal())
```

# `ggmap`

[`ggmap`](https://github.com/dkahle/ggmap) is a package for R that retrieves raster map tiles from online mapping services like [Google Maps](https://www.google.com/maps) and plots them using the `ggplot2` framework. The map tiles are **raster** because they are static image files generated previously by the mapping service. You do not need any data files containing information on things like scale, projection, boundaries, etc. because that information is already created by the map tile. This severely limits your ability to redraw or change the appearance of the geographic map, however the tradeoff means you can immediately focus on incorporating additional data into the map.

# Obtain map images

`ggmap` supports open-source map providers such as [OpenStreetMap](https://www.openstreetmap.org/) and [Stamen Maps](http://maps.stamen.com/#terrain/12/37.7706/-122.3782), as well as the proprietary Google Maps. Obtaining map tiles requires use of the `get_map()` function. There are two formats for specifying the mapping region you wish to obtain:

1. Bounding box
1. Center/zoom

## Specifying map regions

### Bounding box

**Bounding box** requires the user to specify the four corners of the box defining the map region. For instance, to obtain a map of Chicago using Stamen Maps:

```{r bb-chicago-stamen}
# store bounding box coordinates
chi_bb <- c(left = -87.936287,
            bottom = 41.679835,
            right = -87.447052,
            top = 42.000835)

chicago_stamen <- get_stamenmap(bbox = chi_bb,
                                zoom = 11)
chicago_stamen
```

To view the map, use `ggmap()`:

```{r bb-chicago-stamen-plot}
ggmap(chicago_stamen)
```

The `zoom` argument in `get_stamenmap()` controls the level of detail in the map. The larger the number, the greater the detail.

```{r bb-chicago-stamen-zoom-in}
get_stamenmap(bbox = chi_bb,
              zoom = 12) %>%
  ggmap()
```

The smaller the number, the lesser the detail.

```{r bb-chicago-stamen-zoom-out}
get_stamenmap(bbox = chi_bb,
              zoom = 10) %>%
  ggmap()
```


Trial and error will help you decide on the appropriate level of detail depending on what data you need to visualize on the map.

> Use [bboxfinder.com](http://bboxfinder.com/#0.000000,0.000000,0.000000,0.000000) to determine the exact longitude/latitude coordinates for the bounding box you wish to obtain.

### Center/zoom

While Stamen Maps and OpenStreetMap require the bounding box format for obtaining map tiles and allow you to increase or decrease the level of detail within a single bounding box, Google Maps requires specifying the **center** coordinate of the map (a single longitude/latitude location) and the level of **zoom** or detail. `zoom` is an integer value from `3` (continent) to `21` (building). This means the level of detail is hardcoded to the size of the mapping region. The default `zoom` level is `10`.

```{r center-zoom-chicago}
# store center coordinate
chi_center <- c(lon = -87.65, lat = 41.855)

chicago_google <- get_googlemap(center = chi_center)
ggmap(chicago_google)

get_googlemap(center = chi_center,
              zoom = 12) %>%
  ggmap()

get_googlemap(center = chi_center,
              zoom = 8) %>%
  ggmap()
```

> Use [Find Latitude and Longitude](https://www.findlatitudeandlongitude.com/) to get the exact GPS coordinates of the center location.

## Types of map tiles

Each map tile provider offers a range of different types of maps depending on the background you want for the map. Stamen Maps offers several different types:

```{r stamen-maptype, fig.height = 8, fig.width = 6, echo = FALSE}
stamen_maptype <- data_frame(maptype = c("terrain", "terrain-background",
                                         "terrain-labels", "terrain-lines",
                                         "toner", "toner-2010", "toner-2011",
                                         "toner-background", "toner-hybrid",
                                         "toner-labels", "toner-lines",
                                         "toner-lite", "watercolor")) %>%
  mutate(bb = map(maptype, ~ get_stamenmap(bbox = chi_bb, zoom = 10, maptype = .x)),
         ggmap = map2(bb, maptype, ~ ggmap(.x) +
                        ggtitle(.y)))

grid.arrange(grobs = stamen_maptype$ggmap)
```

Google Maps is a bit more limited, but still offers a few major types:

```{r google-maptype, echo = FALSE}
google_maptype <- data_frame(maptype = c("terrain", "satellite",
                                         "roadmap", "hybrid")) %>%
  mutate(bb = map(maptype, ~ get_googlemap(center = chi_center, maptype = .x)),
         ggmap = map2(bb, maptype, ~ ggmap(.x) +
                        ggtitle(.y)))

grid.arrange(grobs = google_maptype$ggmap)
```

See the documentation for the `get_*map()` function for the exact code necessary to get each type of map.

> `get_map()` is a wrapper that automatically queries Google Maps, OpenStreetMap, or Stamen Maps depending on the function arguments and inputs. While useful, it also combines all the different arguments of `get_googlemap()`, `get_stamenmap()`, and `getopenstreetmap()` and can become a bit jumbled. Use at your own risk.

# Import crime data

```{r import-chicago}
chicago <- get_map(location = c(lon = -87.65, lat = 41.855),
                        zoom = 11)
```

```{r import-crimes}
crimes <- read_csv("data/Crimes_-_2017.csv")
```

```{r tidy-crimes, dependson = "import-crimes"}
crimes <- crimes %>%
  mutate(Date = mdy_hms(Date),
         wday = wday(Date, label = TRUE, abbr = FALSE),
         hour = hour(Date))
```

# Plot high-level map of crime

## Using `geom_point()`

```{r plot-crime-point, dependson = "tidy-crimes"}
ggmap(chicago) +
  geom_point(data = crimes,
             aes(x = Longitude,
                 y = Latitude))

ggmap(chicago) +
  geom_point(data = crimes,
             aes(x = Longitude,
                 y = Latitude),
             size = 1, alpha = .05)
```

## Using `stat_density_2d()`

```{r plot-crime-density, dependson = "tidy-crimes"}
crime_overall <- ggmap(chicago) +
  stat_density_2d(data = crimes,
                  aes(x = Longitude,
                      y = Latitude,
                      fill = ..level..),
                  alpha = .2,
                  bins = 25,
                  geom = "polygon") +
  scale_fill_gradientn(colors = brewer.pal(7, "YlOrRd"))
crime_overall
```

```{r plot-crime-wday, dependson = "tidy-crimes", fig.height = 12}
ggmap(chicago) +
  stat_density_2d(data = filter(crimes, `Primary Type` == "THEFT"),
                  aes(x = Longitude,
                      y = Latitude,
                      fill = ..level..),
                  alpha = .4,
                  bins = 10,
                  geom = "polygon") +
  scale_fill_gradientn(colors = brewer.pal(7, "YlOrRd")) +
  facet_wrap(~ wday, ncol = 2)
```

Make the plot print window bigger, but changes in south side crime rates

# Locations of murders

Use `geom_point()`

```{r get-community-areas, include = FALSE}
library(sf)

# import shapefile with area names and numbers
areas <- st_read("data/Boundaries - Community Areas (current)/geo_export_328cdcbf-33ba-4997-8ce8-90953c6fec19.shp")

crimes %>%
  filter(`Primary Type` == "HOMICIDE") %>%
  count(`Community Area`, sort = TRUE) %>%
  left_join(areas %>%
              select(community, area_numbe) %>%
              mutate(area_numbe = as.numeric(as.character(area_numbe))),
            by = c("Community Area" = "area_numbe"))
```

```{r get-high-low-murder-maps}
# North Lawndale is the highest homicides in 2017
# Compare to Kenwood
north_lawndale <- get_map(location = c(lon = -87.714401,
                                lat = 41.858768),
                     zoom = 14)

kenwood <- get_map(location = c(lon = -87.59320836086425,
                                lat = 41.80965352973664),
                   zoom = 15)
```

```{r plot-murder, dependson = "tidy-crime"}
murders <- crimes %>%
  filter(`Primary Type` == "HOMICIDE")

ggmap(north_lawndale) +
  geom_point(data = murders,
             aes(x = Longitude, y = Latitude))

ggmap(kenwood) +
  geom_point(data = murders,
             aes(x = Longitude, y = Latitude))
```

# Additional resources {.toc-ignore}

* [Kahle, D., & Wickham, H. (2013). `ggmap`: Spatial Visualization with ggplot2. *R Journal*, 5(1).](https://journal.r-project.org/archive/2013/RJ-2013-014/RJ-2013-014.pdf)

# Acknowledgments {.toc-ignore}


# Session Info {.toc-ignore}

```{r child='_sessioninfo.Rmd'}
```
