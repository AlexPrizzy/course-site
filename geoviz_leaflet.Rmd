---
title: "Drawing interactive maps with `leaflet`"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE)
```

```{r packages, cache = FALSE, message = FALSE}
library(tidyverse)
library(leaflet)
library(RColorBrewer)

options(digits = 3)
set.seed(1234)
theme_set(theme_minimal())
```

# Intro to Leaflet

[Leaflet](https://leafletjs.com/) is an open-source JavaScript library for creating interactive maps. Unlike static visualization packages such as `ggplot2` or `ggmap`, Leaflet maps are fully interactive and can include features such as:

* Interactive panning/zooming
* Pop-up tooltips and labels
* Highlighting/selecting regions

It is used by many news organizations and tech websites to visualize geographic data. The `leaflet` package for R enables the creation of interactive maps within R without learning how to write JavaScript code. The [`leaflet` documentation](https://rstudio.github.io/leaflet/) is a handy walkthrough for the basics of creating Leaflet maps in R. Let's explore here how to create Leaflet maps using the same data we used to create [raster maps with `ggmap`](geoviz_ggmap.html), [crime data from the city of Chicago in 2017](https://data.cityofchicago.org/Public-Safety/Crimes-2017/d62x-nvdr).^[[Full documentation of the data from the larger 2001-present crime dataset.](https://data.cityofchicago.org/Public-Safety/Crimes-2001-to-present/ijzp-q8t2).]

```{r import-crimes}
crimes <- read_csv("data/Crimes_-_2017.csv")
glimpse(crimes)
```

# Basic usage

Leaflet maps are built using layers, similar to `ggplot2`.

1. Create a map widget by calling `leaflet()`
1. Add **layers** to the map using one or more of the layer functions (e.g. `addTiles()`, `addMarkers()`, `addPolygons()`)
1. Repeat step 2 as many times as necessary to incorporate the necessary information
1. Display the map widget

A basic example is:

```{r leaflet-basic}
m <- leaflet() %>%
  addTiles() %>%
  addMarkers(lng = -87.597241, lat = 41.789829,
             popup = "Saieh Hall of Economics")
m
```

# Basemaps

Like `ggmap`, `leaflet` supports basemaps using map tiles. By default, OpenStreetMap tiles are used.

```{r basemap}
m <- leaflet() %>%
  setView(lng = -87.618994, lat = 41.875619, zoom = 12)
m %>% addTiles()
```

To use a different basemap provider, use `addProviderTiles()` with the name of the provider you wish to implement. You can view the complete list of providers using `names(providers)`.

```{r basemap-third-party, dependson = "basemap"}
m %>% addProviderTiles(providers$Stamen.Toner)
m %>% addProviderTiles(providers$CartoDB.Positron)
m %>% addProviderTiles(providers$Esri.NatGeoWorldMap)
m %>% addProviderTiles(providers$Wikimedia)
```

# Add markers

**Markers** are used to identify points on the map. Each point needs to be defined in terms of latitude/longitude coordinates. These can come from a variety of sources, most commonly either a [map data file](geoviz_import_data.html) such as a shapefile or GeoJSON (imported using `sf`) or a data frame with latitude and longitude columns.

Let's use the Chicago crimes data to draw a map of the city identifying the location of each reported homicide:

```{r homicide, dependson = "import-crimes"}
(homicides <- crimes %>%
  filter(`Primary Type` == "HOMICIDE"))
```

```{r homicide-map, dependson = "homicide"}
leaflet(data = homicides) %>%
  addTiles() %>%
  addMarkers()
```

> `addMarkers()` and related functions will automatically check data frames for columns called ` lng`/`long`/`longitude` and `lat`/`latitude` (case-insensitively). If your coordinate columns have any other names, you need to explicitly identify them using the `lng` and `lat` arguments. Such as `addMarkers(lng = ~Longitude, lat = ~Latitude).

Without any customization, we get a basic map with each murder location indicated by a dropped pin. Each markers appearance can be customized, though the technical difficulty quickly ramps up. The [awesome markers](https://github.com/lvoogdt/Leaflet.awesome-markers) plugin offers the most straight-forward customizability options. Instead of using `addMarkers()`, use `addAwesomeMarkers()` to control the appearance of the markers using icons from the [Font Awesome](http://fontawesome.io/icons/), [Bootstrap Glyphicons](https://getbootstrap.com/components/), and [Ion icons](http://ionicons.com/) icon libraries. First you define the appearance of the icon using `awesomeIcons()`, then pass that as an argument to `addAwesomeMarkers()`:

```{r homicide-map-icons, dependson = "homicide"}
icons <- awesomeIcons(
  icon = 'bolt',
  iconColor = 'orange',
  markerColor = "black",
  library = 'fa'
)

leaflet(data = homicides) %>%
  addTiles() %>%
  addAwesomeMarkers(icon = icons)
```

One concern is that some neighborhoods have so many murders that the points overlap. One solution enabled by Leaflet's interactivity is to **cluster** markers at varying levels of detail using the `clusterOptions` argument to `addMarkers()`:

```{r homicide-map-cluster, dependson = "homicide"}
leaflet(data = homicides) %>%
  addTiles() %>%
  addMarkers(clusterOptions = markerClusterOptions())
```

Alternatively, we could use circles using `addCircleMarkers()`:

```{r homicide-map-circles, dependson = "homicide"}
leaflet(data = homicides) %>%
  addTiles() %>%
  addCircleMarkers()
```

# Add labels


# Add lines and shapes


# Add legend


# Choropleth of crime rates by neighborhood

# Additional resources {.toc-ignore}


# Session Info {.toc-ignore}

```{r child='_sessioninfo.Rmd'}
```
